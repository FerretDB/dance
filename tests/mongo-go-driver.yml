---
runner: gotest
args:
  - -timeout=2m
  - -shuffle=on
  - ./examples/...
  - ./mongo
  - ./mongo/gridfs
  - ./x/mongo/driver/integration
  - ./x/mongo/driver/topology
  - ./mongo/integration
  - ./mongo/integration/unified

results:
  common:
    skip:
      - output_regex: "skipping due to environmental constraints:.*"
      - output_regex: "skipping due to known failure:.*"
      - output_regex: "server version \"5.0.9\" is (lower|higher).*"

      # needs replica set
      - go.mongodb.org/mongo-driver/examples/documentation_examples/TestChangeStreamExamples
      - go.mongodb.org/mongo-driver/examples/documentation_examples/TestDocumentationExamples/CausalConsistencyExamples
      - go.mongodb.org/mongo-driver/examples/documentation_examples/TestDocumentationExamples/ChangeStreamExamples
      - go.mongodb.org/mongo-driver/examples/documentation_examples/TestDocumentationExamples/SnapshotQueryExamples
      - go.mongodb.org/mongo-driver/examples/documentation_examples/TestDocumentationExamples/TransactionsExamples
      - go.mongodb.org/mongo-driver/examples/documentation_examples/TestDocumentationExamples/WithTransactionExample
      - go.mongodb.org/mongo-driver/examples/documentation_examples/TestTransactionExamples
      - go.mongodb.org/mongo-driver/mongo/TestConvenientTransactions

      # OCSP
      - go.mongodb.org/mongo-driver/mongo/TestOCSP

      # test requires that close does not aggressively close used connections
      - go.mongodb.org/mongo-driver/x/mongo/driver/topology/TestCMAPSpec/pool-checkin-destroy-closed.json
      - go.mongodb.org/mongo-driver/x/mongo/driver/topology/TestCMAPSpec/pool-close-destroy-conns.json

      # event ordering incompatible with load-balancer SDAM spec test
      - go.mongodb.org/mongo-driver/x/mongo/driver/topology/TestCMAPSpec/pool-create-min-size-error.json

      # test requires that connections established by minPoolSize
      # are immediately used to satisfy check-out requests 
      - go.mongodb.org/mongo-driver/x/mongo/driver/topology/TestCMAPSpec/pool-checkout-minPoolSize-connection-maxConnecting.json

      # test requires a checked-in connections cannot satisfy a check-out waiting on a new connection
      - go.mongodb.org/mongo-driver/x/mongo/driver/topology/TestCMAPSpec/pool-checkout-returned-connection-maxConnecting.json

      # skip if CRYPT_SHARED_LIB_PATH is not set
      - go.mongodb.org/mongo-driver/mongo/TestClient/mongocryptd_or_crypt_shared

      # skip if no compressor specified
      - go.mongodb.org/mongo-driver/x/mongo/driver/integration/TestCompression

      # always skipped
      - go.mongodb.org/mongo-driver/x/mongo/driver/integration/TestInsert

      # skip because authentication is required
      - go.mongodb.org/mongo-driver/x/mongo/driver/integration/TestSCRAM

      # aggregate comments are string-only
      - go.mongodb.org/mongo-driver/mongo/integration/unified/TestUnifiedSpec/crud/unified/aggregate.json/aggregate_with_comment_sets_comment_on_getMore

      # runOnBlock requires CSFLE to be enabled.
      - go.mongodb.org/mongo-driver/mongo/integration/unified/TestUnifiedSpec/unified-test-format/valid-fail/kmsProviders-missing_aws_kms_credentials.json
      - go.mongodb.org/mongo-driver/mongo/integration/unified/TestUnifiedSpec/unified-test-format/valid-fail/kmsProviders-missing_azure_kms_credentials.json
      - go.mongodb.org/mongo-driver/mongo/integration/unified/TestUnifiedSpec/unified-test-format/valid-fail/kmsProviders-missing_gcp_kms_credentials.json
      - go.mongodb.org/mongo-driver/mongo/integration/unified/TestUnifiedSpec/unified-test-format/valid-fail/kmsProviders-no_kms.json
      - go.mongodb.org/mongo-driver/mongo/integration/unified/TestUnifiedSpec/unified-test-format/valid-pass/kmsProviders-explicit_kms_credentials.json
      - go.mongodb.org/mongo-driver/mongo/integration/unified/TestUnifiedSpec/unified-test-format/valid-pass/kmsProviders-mixed_kms_credential_fields.json
      - go.mongodb.org/mongo-driver/mongo/integration/unified/TestUnifiedSpec/unified-test-format/valid-pass/kmsProviders-placeholder_kms_credentials.json
      - go.mongodb.org/mongo-driver/mongo/integration/unified/TestUnifiedSpec/unified-test-format/valid-pass/kmsProviders-unconfigured_kms.json

      # mismatched values for server parameter "acceptApiVersion2"; expected true
      - go.mongodb.org/mongo-driver/mongo/integration/unified/TestUnifiedSpec/versioned-api/test-commands-deprecation-errors.json

      # operation listIndexNames not implemented
      - go.mongodb.org/mongo-driver/mongo/integration/TestUnifiedSpecs/retryable-reads/listIndexNames-serverErrors.json/ListIndexNames_fails_after_NotWritablePrimary_when_retryReads_is_false
      - go.mongodb.org/mongo-driver/mongo/integration/TestUnifiedSpecs/retryable-reads/listIndexNames-serverErrors.json/ListIndexNames_fails_after_two_NotWritablePrimary_errors
      - go.mongodb.org/mongo-driver/mongo/integration/TestUnifiedSpecs/retryable-reads/listIndexNames-serverErrors.json/ListIndexNames_succeeds_after_HostNotFound
      - go.mongodb.org/mongo-driver/mongo/integration/TestUnifiedSpecs/retryable-reads/listIndexNames-serverErrors.json/ListIndexNames_succeeds_after_HostUnreachable
      - go.mongodb.org/mongo-driver/mongo/integration/TestUnifiedSpecs/retryable-reads/listIndexNames-serverErrors.json/ListIndexNames_succeeds_after_InterruptedAtShutdown
      - go.mongodb.org/mongo-driver/mongo/integration/TestUnifiedSpecs/retryable-reads/listIndexNames-serverErrors.json/ListIndexNames_succeeds_after_InterruptedDueToReplStateChange
      - go.mongodb.org/mongo-driver/mongo/integration/TestUnifiedSpecs/retryable-reads/listIndexNames-serverErrors.json/ListIndexNames_succeeds_after_NetworkTimeout
      - go.mongodb.org/mongo-driver/mongo/integration/TestUnifiedSpecs/retryable-reads/listIndexNames-serverErrors.json/ListIndexNames_succeeds_after_NotPrimaryNoSecondaryOk
      - go.mongodb.org/mongo-driver/mongo/integration/TestUnifiedSpecs/retryable-reads/listIndexNames-serverErrors.json/ListIndexNames_succeeds_after_NotPrimaryOrSecondary
      - go.mongodb.org/mongo-driver/mongo/integration/TestUnifiedSpecs/retryable-reads/listIndexNames-serverErrors.json/ListIndexNames_succeeds_after_NotWritablePrimary
      - go.mongodb.org/mongo-driver/mongo/integration/TestUnifiedSpecs/retryable-reads/listIndexNames-serverErrors.json/ListIndexNames_succeeds_after_PrimarySteppedDown
      - go.mongodb.org/mongo-driver/mongo/integration/TestUnifiedSpecs/retryable-reads/listIndexNames-serverErrors.json/ListIndexNames_succeeds_after_ShutdownInProgress
      - go.mongodb.org/mongo-driver/mongo/integration/TestUnifiedSpecs/retryable-reads/listIndexNames-serverErrors.json/ListIndexNames_succeeds_after_SocketException
      - go.mongodb.org/mongo-driver/mongo/integration/TestUnifiedSpecs/retryable-reads/listIndexNames.json/ListIndexNames_fails_on_first_attempt
      - go.mongodb.org/mongo-driver/mongo/integration/TestUnifiedSpecs/retryable-reads/listIndexNames.json/ListIndexNames_fails_on_second_attempt
      - go.mongodb.org/mongo-driver/mongo/integration/TestUnifiedSpecs/retryable-reads/listIndexNames.json/ListIndexNames_succeeds_on_first_attempt
      - go.mongodb.org/mongo-driver/mongo/integration/TestUnifiedSpecs/retryable-reads/listIndexNames.json/ListIndexNames_succeeds_on_second_attempt
      - go.mongodb.org/mongo-driver/mongo/integration/TestUnifiedSpecs/retryable-reads/mapReduce.json/MapReduce_fails_with_retry_off

      # long running integration test outside of evergreen
      - go.mongodb.org/mongo-driver/mongo/integration/TestCollection/insert_many/batches
      - go.mongodb.org/mongo-driver/mongo/integration/TestCollection/insert_many/large_document_batches
      - go.mongodb.org/mongo-driver/mongo/integration/TestCollection/insert_many/writeError_index
      - go.mongodb.org/mongo-driver/mongo/integration/TestCollection/insert_many/write_concern_error
        

  ferretdb:
    stats:
      unexpected_fail: 0
      unexpected_skip: 0
      unexpected_pass: 0
      expected_fail: 23
      expected_skip: 17
      expected_pass: 717

    pass:
      - go.mongodb.org/mongo-driver/mongo/TestClient/

      - go.mongodb.org/mongo-driver/examples/documentation_examples/TestDocumentationExamples/DeleteExamples
      - go.mongodb.org/mongo-driver/examples/documentation_examples/TestDocumentationExamples/IndexExamples
      - go.mongodb.org/mongo-driver/examples/documentation_examples/TestDocumentationExamples/InsertExamples
      - go.mongodb.org/mongo-driver/examples/documentation_examples/TestDocumentationExamples/QueryEmbeddedDocumentsExamples
      - go.mongodb.org/mongo-driver/examples/documentation_examples/TestDocumentationExamples/QueryNullMissingFieldsExamples
      - go.mongodb.org/mongo-driver/examples/documentation_examples/TestDocumentationExamples/QueryToplevelFieldsExamples
      - go.mongodb.org/mongo-driver/examples/documentation_examples/TestDocumentationExamples/RunCommandExamples
      - go.mongodb.org/mongo-driver/examples/documentation_examples/TestDocumentationExamples/StableAPExamples
      - go.mongodb.org/mongo-driver/examples/documentation_examples/TestDocumentationExamples/TestDocumentationExamples/DeleteExamples
      - go.mongodb.org/mongo-driver/examples/documentation_examples/TestDocumentationExamples/TestDocumentationExamples/QueryNullMissingFieldsExamples

    fail:
      # database/collection names https://github.com/FerretDB/FerretDB/issues/125
      - go.mongodb.org/mongo-driver/examples/documentation_examples/TestAggregationExamples
      - go.mongodb.org/mongo-driver/examples/documentation_examples/TestDocumentationExamples

      # projection https://github.com/FerretDB/FerretDB/issues/80
      - go.mongodb.org/mongo-driver/mongo/gridfs/TestGridFS

      # aggregate https://github.com/FerretDB/FerretDB/issues/9
      - go.mongodb.org/mongo-driver/x/mongo/driver/integration/TestAggregate
      - go.mongodb.org/mongo-driver/x/mongo/driver/integration/TestAggregate/AllowDiskUse
      - go.mongodb.org/mongo-driver/x/mongo/driver/integration/TestAggregate/Multiple_Batches
      - go.mongodb.org/mongo-driver/x/mongo/driver/integration/TestAggregate/TestMaxTimeMSInGetMore
      - go.mongodb.org/mongo-driver/mongo/TestClient/endSessions/number_of_sessions_divides_evenly
      - go.mongodb.org/mongo-driver/mongo/TestClient/endSessions/number_of_sessions_does_not_divide_evenly
      - go.mongodb.org/mongo-driver/mongo/TestClient/endSessions
      - go.mongodb.org/mongo-driver/mongo/TestClient

      # session commands https://github.com/FerretDB/FerretDB/issues/153
      - go.mongodb.org/mongo-driver/mongo/integration/unified/TestUnifiedSpec

  mongodb:
    stats:
      unexpected_fail: 0
      unexpected_skip: 0
      unexpected_pass: 0
      expected_fail: 2
      expected_skip: 138
      expected_pass: 1160
    fail:
      - go.mongodb.org/mongo-driver/examples/documentation_examples/TestDocumentationExamples
      - go.mongodb.org/mongo-driver/examples/documentation_examples/TestDocumentationExamples/StableAPIStrictCountExample
    pass:
      - go.mongodb.org/mongo-driver/examples/documentation_examples/TestDocumentationExamples/AggregationExamples
      - go.mongodb.org/mongo-driver/examples/documentation_examples/TestDocumentationExamples/DeleteExamples
      - go.mongodb.org/mongo-driver/examples/documentation_examples/TestDocumentationExamples/IndexExamples
      - go.mongodb.org/mongo-driver/examples/documentation_examples/TestDocumentationExamples/InsertExamples
      - go.mongodb.org/mongo-driver/examples/documentation_examples/TestDocumentationExamples/ProjectionExamples
      - go.mongodb.org/mongo-driver/examples/documentation_examples/TestDocumentationExamples/QueryArrayEmbeddedDocumentsExamples
      - go.mongodb.org/mongo-driver/examples/documentation_examples/TestDocumentationExamples/QueryArraysExamples
      - go.mongodb.org/mongo-driver/examples/documentation_examples/TestDocumentationExamples/QueryEmbeddedDocumentsExamples
      - go.mongodb.org/mongo-driver/examples/documentation_examples/TestDocumentationExamples/QueryNullMissingFieldsExamples
      - go.mongodb.org/mongo-driver/examples/documentation_examples/TestDocumentationExamples/QueryToplevelFieldsExamples
      - go.mongodb.org/mongo-driver/examples/documentation_examples/TestDocumentationExamples/RunCommandExamples
      - go.mongodb.org/mongo-driver/examples/documentation_examples/TestDocumentationExamples/StableAPExamples
      - go.mongodb.org/mongo-driver/examples/documentation_examples/TestDocumentationExamples/UpdateExamples
